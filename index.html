<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arsa Payı ve Değer Hesaplayıcı (Pro)</title>
    <style>
        /* --- GENEL AYARLAR (iPhone/Mobil Uyumlu) --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f2f2f7; 
            margin: 0; 
            padding: 10px; 
            color: #1c1c1e;
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column; /* Mobilde alt alta */
            gap: 15px;
        }

        /* Masaüstünde yan yana dursun */
        @media (min-width: 768px) {
            .container { flex-direction: row; align-items: flex-start; }
            .card { flex: 1; }
        }

        /* --- KART YAPISI --- */
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
        }

        h2 { 
            margin-top: 0; 
            font-size: 1.1rem; 
            color: #1c1c1e; 
            text-align: center; 
            border-bottom: 1px solid #e5e5ea; 
            padding-bottom: 10px; 
            margin-bottom: 15px;
        }
        
        /* --- SEKME BUTONLARI --- */
        .tabs {
            display: flex;
            margin-bottom: 12px;
            background-color: #f2f2f7;
            padding: 4px;
            border-radius: 10px;
        }
        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #8e8e93;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab-btn.active {
            background-color: #ffffff;
            color: #007aff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* --- FORM ELEMANLARI --- */
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #8e8e93; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #d1d1d6; 
            border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box;
            background-color: #f2f2f7;
            -webkit-appearance: none;
            color: #1c1c1e;
        }
        input:focus { border-color: #007aff; background-color: #fff; outline: none; }

        .row-inputs { display: flex; gap: 10px; }
        .row-inputs .form-group { flex: 1; }

        /* --- BUTONLAR --- */
        .btn-container { display: flex; gap: 10px; margin-top: 15px; }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:active { transform: scale(0.98); opacity: 0.8; }

        .btn-calc { background-color: #007aff; color: white; }
        .btn-update { background-color: #ff9500; color: white; }
        .btn-reset { background-color: #e5e5ea; color: #1c1c1e; }

        /* --- SONUÇ ALANI --- */
        .result-area {
            margin-top: 20px;
            background-color: #f2f2f7;
            border-radius: 10px;
            padding: 15px;
        }
        .res-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .res-row span:first-child { color: #666; }
        .res-row strong { color: #000; font-weight: 600; }
        .highlight { color: #007aff !important; font-size: 1.1rem; }

        /* --- TABLO (LİSTE) --- */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 300px; }
        th { text-align: left; background: #f2f2f7; padding: 10px; color: #8e8e93; font-weight: 600; }
        td { padding: 12px 10px; border-bottom: 1px solid #e5e5ea; vertical-align: middle; }
        
        .action-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; border-radius: 6px; flex: none; width: auto; }
        .btn-edit { background-color: #ff9500; color: white; }
        .btn-del { background-color: #ff3b30; color: white; }

        /* Düzenleme Modu Bannerı */
        #editBanner {
            background-color: #ff9500; color: white; text-align: center; padding: 8px; 
            border-radius: 8px; margin-bottom: 15px; display: none; font-weight: bold; font-size: 0.9rem;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="card">
        <h2>Veri Girişi ve Hesaplama</h2>

        <!-- SEKME BUTONLARI -->
        <div class="tabs">
            <button id="tabPay"  class="tab-btn active" onclick="sekmeDegistir('pay')">Arsa Payı</button>
            <button id="tabAlan" class="tab-btn"         onclick="sekmeDegistir('alan')">Arsa Alanı</button>
        </div>
        
        <div id="editBanner">Düzenleme Modu Aktif</div>
        <input type="hidden" id="recordId">

        <div class="form-group">
            <label for="kayitAdi">Kayıt Adı / Blok / Daire No</label>
            <input type="text" id="kayitAdi" placeholder="Örn: A Blok Daire 5">
        </div>

        <div class="form-group">
            <label for="arsaAlani" id="labelArsaAlani">Parsel Arsa Alanı (m²)</label>
            <input type="number" id="arsaAlani" inputmode="decimal">
        </div>

        <!-- Bu satır sadece "Arsa Payı" sekmesinde görünecek -->
        <div class="row-inputs" id="rowPayGroup">
            <div class="form-group">
                <label for="arsaPay">Arsa Pay</label>
                <input type="number" id="arsaPay" inputmode="decimal">
            </div>
            <div class="form-group">
                <label for="arsaPayda">Arsa Payda</label>
                <input type="number" id="arsaPayda" inputmode="decimal">
            </div>
        </div>

        <div class="form-group">
            <label for="daireAlani">Daire Alanı (m²)</label>
            <input type="number" id="daireAlani" inputmode="decimal">
        </div>

        <div class="form-group">
            <label for="yapiMaliyeti">Yapı Birim Maliyeti (TL/m²)</label>
            <input type="number" id="yapiMaliyeti" inputmode="decimal">
        </div>

        <div class="form-group">
            <label for="toplamDeger">Toplam Değer (TL)</label>
            <input type="number" id="toplamDeger" inputmode="decimal">
        </div>

        <div class="form-group">
            <label for="serefiyeOrani">Şerefiye Oranı  Müteahhit Karı (%)</label>
            <input type="number" id="serefiyeOrani" inputmode="decimal">
        </div>

        <div class="btn-container">
            <button class="btn-calc" id="btnIslem" onclick="kaydetVeHesapla()">HESAPLA & KAYDET</button>
        </div>
        <div class="btn-container" style="margin-top:10px;">
             <button class="btn-reset" onclick="temizle()">Temizle / Yeni Kayıt</button>
        </div>

        <div class="result-area" id="sonucAlani">
            <div class="res-row"><span id="resArsaLabel">Arsa Payı Alanı:</span> <strong id="resArsaPayiAlani">0,00 m²</strong></div>
            <div class="res-row"><span>Toplam Yapı Maliyeti:</span> <strong id="resYapiMaliyeti">0,00 TL</strong></div>
            <div class="res-row"><span>Şerefiye Değeri:</span> <strong id="resSerefiye">0,00 TL</strong></div>
            <div class="res-row"><span>Arsa Değeri:</span> <strong id="resArsaDegeri">0,00 TL</strong></div>
            <div style="border-top:1px solid #d1d1d6; margin:8px 0;"></div>
            <div class="res-row"><span>Birim Değer:</span> <strong class="highlight" id="resBirimDeger">0,00 TL/m²</strong></div>
        </div>
    </div>

    <div class="card">
        <h2>Kaydedilenler</h2>
        <div class="table-wrapper">
            <table id="listeTablosu">
                <thead>
                    <tr>
                        <th>Tanım</th>
                        <th>Yöntem</th>
                        <th>Birim Değer</th>
                        <th style="text-align:right">İşlem</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="bosMesaj" style="text-align:center; padding:20px; color:#999; font-size:0.9rem;">Henüz kayıt yok.</div>
    </div>

</div>

<script>
    // Aktif sekme: 'pay' (Arsa Payı) veya 'alan' (Arsa Alanı)
    let aktifSekme = 'pay';

    // Sayfa Yüklendiğinde
    document.addEventListener('DOMContentLoaded', function() {
        listeyiGuncelle();
        canliHesapla();

        const alanlar = ['arsaAlani','arsaPay','arsaPayda','daireAlani','yapiMaliyeti','toplamDeger','serefiyeOrani'];
        alanlar.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', canliHesapla);
        });
    });

    // Sekme değiştirme
    function sekmeDegistir(mod) {
        aktifSekme = mod;

        document.getElementById('tabPay').classList.toggle('active', mod === 'pay');
        document.getElementById('tabAlan').classList.toggle('active', mod === 'alan');

        const rowPay = document.getElementById('rowPayGroup');
        if (mod === 'pay') {
            rowPay.style.display = 'flex';
            document.getElementById('labelArsaAlani').innerText = 'Parsel Arsa Alanı (m²)';
        } else {
            rowPay.style.display = 'none';
            document.getElementById('labelArsaAlani').innerText = 'Arsa Alanı (m²)';
        }

        canliHesapla();
    }

    // Para Formatı
    function formatTL(num) {
        if (!isFinite(num)) num = 0;
        return num.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Hesaplama
    function hesapla(veri) {
        if (veri.mod === 'pay' && veri.arsaPayda <= 0) {
            return {
                arsaPayiAlani: 0,
                toplamYapiMaliyeti: 0,
                serefiyeDegeri: 0,
                arsaDegeri: 0,
                birimDeger: 0
            };
        }

        let arsaPayiAlani = 0;

        if (veri.mod === 'pay') {
            arsaPayiAlani = (veri.arsaAlani * veri.arsaPay) / (veri.arsaPayda || 1);
        } else {
            arsaPayiAlani = veri.arsaAlani;
        }

        let toplamYapiMaliyeti = veri.daireAlani * veri.yapiMaliyeti;
        let serefiyeDegeri     = veri.toplamDeger * (veri.serefiyeOrani / 100);
        let arsaDegeri         = veri.toplamDeger - (toplamYapiMaliyeti + serefiyeDegeri);

        let birimDeger = 0;
        if (arsaPayiAlani > 0) {
            birimDeger = arsaDegeri / arsaPayiAlani;
        }

        return {
            arsaPayiAlani,
            toplamYapiMaliyeti,
            serefiyeDegeri,
            arsaDegeri,
            birimDeger
        };
    }

    // Canlı hesaplama
    function canliHesapla() {
        const veri = formVerileriniAl(false);
        const sonuc = hesapla(veri);
        sonuclariGoster(sonuc);
    }

    // Sonuçları göster
    function sonuclariGoster(sonuc) {
        // Etiket: Arsa Payı / Arsa Alanı
        const label = document.getElementById('resArsaLabel');
        label.innerText = (aktifSekme === 'pay') ? 'Arsa Payı Alanı:' : 'Arsa Alanı:';

        document.getElementById('resArsaPayiAlani').innerText = formatTL(sonuc.arsaPayiAlani) + " m²";
        document.getElementById('resYapiMaliyeti').innerText = formatTL(sonuc.toplamYapiMaliyeti) + " TL";
        document.getElementById('resSerefiye').innerText = formatTL(sonuc.serefiyeDegeri) + " TL";
        document.getElementById('resArsaDegeri').innerText = formatTL(sonuc.arsaDegeri) + " TL";
        document.getElementById('resBirimDeger').innerText = formatTL(sonuc.birimDeger) + " TL/m²";
    }

    // Form verisi okuma
    function formVerileriniAl(validate = false) {
        const veri = {
            id: document.getElementById('recordId').value,
            mod: aktifSekme,
            ad: document.getElementById('kayitAdi').value || 'İsimsiz Kayıt',
            arsaAlani: parseFloat(document.getElementById('arsaAlani').value) || 0,
            arsaPay: parseFloat(document.getElementById('arsaPay').value) || 0,
            arsaPayda: parseFloat(document.getElementById('arsaPayda').value) || 0,
            daireAlani: parseFloat(document.getElementById('daireAlani').value) || 0,
            yapiMaliyeti: parseFloat(document.getElementById('yapiMaliyeti').value) || 0,
            toplamDeger: parseFloat(document.getElementById('toplamDeger').value) || 0,
            serefiyeOrani: parseFloat(document.getElementById('serefiyeOrani').value) || 0
        };

        if (validate) {
            const zorunluGenel = [
                { alan: 'arsaAlani',   deger: veri.arsaAlani,   etiket: 'Arsa Alanı' },
                { alan: 'daireAlani',  deger: veri.daireAlani,  etiket: 'Daire Alanı' },
                { alan: 'yapiMaliyeti',deger: veri.yapiMaliyeti,etiket: 'Yapı Birim Maliyeti' },
                { alan: 'toplamDeger', deger: veri.toplamDeger, etiket: 'Toplam Değer' }
            ];

            const zorunluPay = [
                { alan: 'arsaPay',   deger: veri.arsaPay,   etiket: 'Arsa Pay' },
                { alan: 'arsaPayda', deger: veri.arsaPayda, etiket: 'Arsa Payda' }
            ];

            let zorunlu = zorunluGenel.slice();
            if (veri.mod === 'pay') {
                zorunlu = zorunlu.concat(zorunluPay);
            }

            const eksik = zorunlu.find(x => x.deger <= 0);
            if (eksik) {
                alert(eksik.etiket + " alanı boş bırakılamaz veya 0 olamaz.");
                document.getElementById(eksik.alan).focus();
                return null;
            }

            if (veri.mod === 'pay' && veri.arsaPayda <= 0) {
                alert("Arsa Payda sıfır veya negatif olamaz.");
                document.getElementById('arsaPayda').focus();
                return null;
            }
        }

        return veri;
    }

    // Kaydet & Hesapla
    function kaydetVeHesapla() {
        let veri = formVerileriniAl(true);
        if (!veri) return;

        let sonuc = hesapla(veri);
        sonuclariGoster(sonuc);

        let yeniKayit = {
            id: veri.id ? parseInt(veri.id) : Date.now(),
            ad: veri.ad,
            inputs: veri,
            results: sonuc
        };

        let kayitlar = JSON.parse(localStorage.getItem('emlakDB')) || [];

        if (veri.id) {
            let index = kayitlar.findIndex(k => k.id == veri.id);
            if (index !== -1) kayitlar[index] = yeniKayit;
        } else {
            kayitlar.push(yeniKayit);
        }

        localStorage.setItem('emlakDB', JSON.stringify(kayitlar));
        listeyiGuncelle();

        if (veri.id) {
            temizle();
        }
    }

    // Listeleme
    function listeyiGuncelle() {
        let kayitlar = JSON.parse(localStorage.getItem('emlakDB')) || [];
        let tbody = document.querySelector('#listeTablosu tbody');
        tbody.innerHTML = '';

        if (kayitlar.length === 0) {
            document.getElementById('bosMesaj').style.display = 'block';
        } else {
            document.getElementById('bosMesaj').style.display = 'none';
            kayitlar.slice().reverse().forEach(k => {
                const yontemText = (k.inputs.mod === 'alan') ? 'Arsa Alanı' : 'Arsa Payı';
                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${k.ad}</div>
                    </td>
                    <td>${yontemText}</td>
                    <td>${formatTL(k.results.birimDeger)}</td>
                    <td style="text-align:right">
                        <div class="action-btns">
                            <button class="btn-sm btn-edit" onclick="duzenle(${k.id})">Düzenle</button>
                            <button class="btn-sm btn-del" onclick="sil(${k.id})">Sil</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // Silme
    function sil(id) {
        if (confirm('Bu kaydı silmek istediğinize emin misiniz?')) {
            let kayitlar = JSON.parse(localStorage.getItem('emlakDB')) || [];
            kayitlar = kayitlar.filter(k => k.id !== id);
            localStorage.setItem('emlakDB', JSON.stringify(kayitlar));
            listeyiGuncelle();
            
            if (document.getElementById('recordId').value == id) {
                temizle();
            }
        }
    }

    // Düzenle
    function duzenle(id) {
        let kayitlar = JSON.parse(localStorage.getItem('emlakDB')) || [];
        let k = kayitlar.find(item => item.id === id);

        if (k) {
            sekmeDegistir(k.inputs.mod || 'pay');

            document.getElementById('recordId').value = k.id;
            document.getElementById('kayitAdi').value = k.ad;
            document.getElementById('arsaAlani').value = k.inputs.arsaAlani;
            document.getElementById('arsaPay').value = k.inputs.arsaPay;
            document.getElementById('arsaPayda').value = k.inputs.arsaPayda;
            document.getElementById('daireAlani').value = k.inputs.daireAlani;
            document.getElementById('yapiMaliyeti').value = k.inputs.yapiMaliyeti;
            document.getElementById('toplamDeger').value = k.inputs.toplamDeger;
            document.getElementById('serefiyeOrani').value = k.inputs.serefiyeOrani;

            document.getElementById('editBanner').style.display = 'block';
            let btn = document.getElementById('btnIslem');
            btn.innerText = "GÜNCELLE";
            btn.classList.remove('btn-calc');
            btn.classList.add('btn-update');

            let sonuc = hesapla(k.inputs);
            sonuclariGoster(sonuc);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Temizle
    function temizle() {
        document.getElementById('recordId').value = '';
        document.getElementById('kayitAdi').value = '';
        document.getElementById('arsaAlani').value = '';
        document.getElementById('arsaPay').value = '';
        document.getElementById('arsaPayda').value = '';
        document.getElementById('daireAlani').value = '';
        document.getElementById('yapiMaliyeti').value = '';
        document.getElementById('toplamDeger').value = '';
        document.getElementById('serefiyeOrani').value = '';

        sonuclariGoster({
            arsaPayiAlani: 0,
            toplamYapiMaliyeti: 0,
            serefiyeDegeri: 0,
            arsaDegeri: 0,
            birimDeger: 0
        });

        document.getElementById('editBanner').style.display = 'none';
        let btn = document.getElementById('btnIslem');
        btn.innerText = "HESAPLA & KAYDET";
        btn.classList.remove('btn-update');
        btn.classList.add('btn-calc');
    }
</script>

</body>
</html>
